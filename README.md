# MER-DEN

## ビルドの流れ（エントリーポイントの TypeScript 化）

- `npm run build:entrypoints` で `entrypoints/*.ts` をコンパイルし、`dist/entrypoints/*.js` を生成します。
  - 高校生向け補足: Word で作った原稿を PDF に書き出すイメージで、「配布用に読みやすくした版」を作っています。
- `npm run build` は上記コマンドを内部で実行するため、通常は `npm run build` だけで ZIP 化まで完了します。
- CI やローカル開発で個別に動作確認したい場合は、`npm run lint` → `npm run typecheck` → `npm run test` → `npm run e2e` → `npm run build:entrypoints` → `npm run build` の順に実行すると迷いません。
  - 高校生向け補足: テストで答案を確認してから清書→提出する、という段取りを並べています。

## E2E テスト (Playwright)

- `npm run e2e` でローカルの E2E テストを実行できます。レポーターはテキストのみで、実行ログはコンソールに表示されます。
- CI では `npm run e2e:ci` を使用し、出力は `.artifacts/e2e` に保存されます（`.gitignore` 済み）。
- HTML レポートや動画・スクリーンショットなどのバイナリ出力は無効化しており、必要に応じて CI の Artifacts からテキストログを参照します。

### スナップショット更新のやり方

- UI の見た目が意図通りに変わった場合は、`npm run e2e:update` を実行して Playwright のスナップショット（比較用のハッシュ値）を更新します。
- スナップショットを更新した Pull Request では、「なぜ更新が必要だったのか」を本文に必ず書いてください。例：デザイン修正、文言変更など。
- 高校生向け補足: 「先生に提出する前に、ノートの最新ページを上書きした理由を説明しよう」というイメージです。

### テストが失敗したときに見る場所

1. **コンソールログ**: テスト実行中のターミナル出力に、失敗したステップやエラー内容が表示されます。まずはここで「どの場面でコケたのか」を確認します。
   - 高校生向け補足: 実験ノートに書いた「何分に何が起きたか」のメモを読む感覚です。
2. **`.artifacts/e2e` フォルダー**: テストが失敗すると、このフォルダーに差分画像・スクリーンショット・トレースファイルがまとまります。
   - 差分画像（`*-diff.png`）は、以前の見た目と今の見た目の違いを色で示してくれます。
   - `*-expected.png` と `*-actual.png` で期待値と実際の画面を並べて比較できます。
   - outerHTML（`*.html`）が保存されている場合は、失敗した要素の HTML をそのまま確認できます。
   - 高校生向け補足: 教室のホワイトボードに貼られた「ビフォー・アフター写真」と「現場の実況メモ」を読み返すイメージです。
3. **レビューでの確認ポイント**: Pull Request を出すときは、レビュアーが迷わないように以下を説明しましょう。
   - 失敗が解消された理由、または差分が意図通りである根拠。
   - 必要なら差分画像や outerHTML にリンクして、「どこが変わったのか」を一緒に示す。
   - 「高校生向け補足: 文化祭の準備で、どの装飾を変えたのかと写真を見せながら説明する」ような丁寧さを意識してください。

## スナップショット運用ポリシー

- 画像・動画・バイナリ形式のスナップショットは採用しません。Pull Request にバイナリを含めないためです。
- UI の差分は DOM・属性・スタイルのテキスト化ログでレビューします。Playwright でも失敗時は JSON ログのみを保存します。
- 特殊なケースで画像比較がどうしても必要な場合は、別ブランチで Git LFS を導入し、レビュアー全員の合意を得てから実施します（デフォルトは禁止）。
